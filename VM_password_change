import paramiko
import openpyxl
import logging

# Set up logging to save output to a file and display on the console
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
    handlers=[
        logging.FileHandler("password_change_log3.txt"),  # Output file
        logging.StreamHandler()  # Console output
    ]
)

def change_password(server_ip, username, old_password, new_password):
    """
    Change the password for a user on a remote server.
    """
    try:
        logging.info(f"Connecting to {server_ip} with the provided password...")

        # Establish an SSH connection
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(server_ip, username=username, password=old_password)

        # Command to change the password
        command = f'echo "{old_password}" | sudo -S sh -c "echo \'{username}:{new_password}\' | chpasswd"'

        stdin, stdout, stderr = ssh.exec_command(command, get_pty=True)


        # Wait for the command to finish
        stdout.channel.recv_exit_status()

        # Check for errors
        error = stderr.read().decode()
        if error:
            logging.error(f"Error changing password on {server_ip}: {error}")
        else:
            logging.info(f"Password successfully changed for {username} on {server_ip}.")
    except paramiko.AuthenticationException:
        raise paramiko.AuthenticationException("Authentication failed.")
    except Exception as e:
        logging.error(f"Failed to connect to {server_ip} or change the password: {e}")
    finally:
        ssh.close()

def read_ips_from_excel(file_path):
    """
    Read a list of IP addresses from an Excel file.
    """
    try:
        workbook = openpyxl.load_workbook(file_path)
        sheet = workbook.active

        # Assuming the IPs are in the first column
        ip_addresses = [row[0].value for row in sheet.iter_rows(min_row=2) if row[0].value]
        return ip_addresses
    except Exception as e:
        logging.error(f"Error reading Excel file: {e}")
        return []

def main():
    # Excel file path containing the list of server IPs
    excel_file_path = "servers8.xlsx"  # Update with the correct file path

    # Username and passwords
    username = "ishika"
    login1_password = "Foundit@123"  # Replace with the first password
    login2_password = "Monster@123"  # Replace with the second password
    new_password = "foundit@123"  # Replace with the desired new password

    # Read IPs from the Excel file
    servers = read_ips_from_excel(excel_file_path)

    if not servers:
        logging.error("No IP addresses found. Please check the Excel file.")
        return

    # Change the password on each server
    for server_ip in servers:
        try:
            # Try with the first password
            change_password(server_ip, username, login1_password, new_password)
        except paramiko.AuthenticationException:
            logging.warning(f"Authentication failed with the first password for {server_ip}. Trying the second password...")
            try:
                # Try with the second password
                change_password(server_ip, username, login2_password, new_password)
            except paramiko.AuthenticationException:
                logging.error(f"Authentication failed with both passwords for {server_ip}.")
            except Exception as e:
                logging.error(f"Failed with the second password for {server_ip}: {e}")
        except Exception as e:
            logging.error(f"An error occurred for {server_ip}: {e}")

if __name__ == "__main__":
    main()
